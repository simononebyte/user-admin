# user-admin

A collection of scripts to automate various user administration task. Where possible
most values should be either calculated or pulled from the configuration file. This 
includes related objects like folders.

## Current Features

* Auto generate user name based on customer policy
* Auto-fallback to alternative user name in the event of a clash
* Set the correct user principle name
* Set the correct email address
* Set the Job Title
* Set the office name, address and phone number
* Append qualifications to DisplayName attribute for inclusion in signatures
* Create folders used by folder redirects and roaming profiles etc
  + Sets Administrators as the owner of a roaming profile to ensure it is accessible correctly
* Protect folders from accidental rename, move and delete
* Prompt for group memberships based on contents of OUs specified in the config file
* Sets the password for the account in a similar style to Office 365 passwords
* Enables the created account
* Places the password in the clipboard

## Future Features

* Initiates Azure AD sync
* Wait for account to sync with Office 365
  + Set the location correctly
  + Set the license
  + Set any group memberships
* Better vetting of the config file into concrete classes rather than a dynamic object

## Config File

The following gives and example of a config file. Further details can be found below.

``` json
{
    "RequireElevated": "true",
    "UsernameFormat": "first",
    "UsernameFallback": "firstl1",
    "EmailDomain": "onebyte.net",
    "OrgUnit": "OU=Staff,OU=Company,DC=ad,DC=onebyte,DC=net",
    "Domain": "AD",
    "Flags": {
        "Qualifications": "false",
        "OfficeAddress": "true"
    },
    "GroupOUs": [
        {
            "Name": "Roles",
            "OU": "OU=Roles,OU=Company,DC=ad,DC=onebyte,DC=net"
        },
        {
            "Name": "Shared Drives",
            "OU": "OU=Shared Drives,OU=Company,DC=ad,DC=onebyte,DC=net"
        }
    ],
    "Offices": [
        {
            "ShortCode": "ts",
            "Name": "Technical Services",
            "Phone": "+44 (0)20 3189 2100",
            "Street": "St Markâ€™s Studios, 14 Chillingworth Road",
            "City": "London",
            "Postcode": "N7 8QL"
        },
        {
            "ShortCode": "ho",
            "Name": "Head Office",
            "Phone": "+44 (0)20 3189 2100",
            "Street": "The Enterprise Centre, University of East Anglia",
            "City": "Norwich",
            "Postcode": "NR4 7TJ"
        }
    ],
    "UserFolders": [
        {
            "DisplayName": "Redirected folders",
            "Path": "\\\\server01\\Folders\\",
            "Protect": "true",
            "AdminGroups": [
                "AD\\Server Admins",
                "AD\\Domain Admins"
            ],
            "ProfileVersion": ""
        },
        {
            "DisplayName": "Roaming Profile",
            "Path": "\\\\server04\\Profiles\\",
            "Protect": "true",
            "AdminGroups": [
                "AD\\Server Admins",
                "AD\\Domain Admins"
            ],
            "ProfileVersion": "V6"
        }
    ]
}
```

## Require Elevated

This settings will cause the script to check for an elevated session. This is
required when running the scripts on a domain controller or other device that
has Azure AD Sync installed. In most other situations elevation is not needed.

| Setting         | Description                                        |
| --------------- | -------------------------------------------------- |
| RequireElevated | If true the script will halt unless it is elevated |

## Username Format / Username Fallback

Each company has a preferred format for their user names. This controls the
preferred format and also the fallback format in the case of a clash.

| Setting          | Description                              |
| ---------------- | ---------------------------------------- |
| UsernameFormat   | The preferred format                     |
| UsernameFallback | The format to use in the case of a clash |

**UsernameFormat:** The format is based on how much of the first and/or
last name to use. So `first` indicates the full first name should be used and
`last` indicates the full last name should be used. These can be combined so
`first.last` would make Simon Buckner become `simon.buckner` . Some companies
only want an initial from one of the name which can be handled using `fx` or
`lx` where `x` is the number of characters to use. E.g. `f1last` would create
a username of `sbuckner` .

**UsernameFallback:** Uses the same formating as `UsernameFormat` to define
the username format to use of the one generated by the preferred option is
already in use by another account.

## Email Domain

What email domain is to be used.

## Organisational Unit

The Active Directory OU where the new user object will be created.

## Domain

This is the old format for the Active Directory domain.

## Feature Flags

Different companies use differing levels of information in the environments.
These flags turn various functionality on or off as required. These are all
boolean flags accepting `true` or `false` .

| Flag           | Description                                              |
| -------------- | -------------------------------------------------------- |
| qualifications | Appends professional qualifications to the display name  |
| office_address | Add predefined office address details to the account     |

## Group OUs

For each OU specified a menu will be displayed that will allow all selection
of all groups required for that user account.

## Offices

If the company uses peoples office address on their accounts then the
acceptable values are listed here.

| Setting    | Description                                         |
| ---------- | --------------------------------------------------- |
| short_code | 2 letter code to select the office by               |
| name       | The name of the office                              |
| phone      | The phone number for the office                     |
| street     | The address of the office, except city and postcode |
| city       | The town or city                                    |
| postcode   | The postcode                                        |

## User Folders

When creating a user it may be required to produce one or more folders in
various locations.

**Note** When creating roaming profile directories, either the user or the Administrators group
needs to be the owner of the folder. If not, the roaming profile will fail to roam. Due to a
strange bug in how PowerShell interacts with the . Net framework, the folder must be specified
as a UNC path and not a local path. E.g, `\\server\share\folder` and not `C:\Folder` 

| Setting         | Description                                           |
| --------------- | ----------------------------------------------------- |
| display_name    | Displayed by the script when creating the folder      |
| path            | PAth to create the folder in                          |
| protect         | Protect the folder from accidental deletion           |
| admin_groups    | A list of groups to grant admin access to this folder |
| profile_version | If this is a profile folder which version to create   |

**Paths:** When a folder is created, the username of the account being created is used.
So if the username is just the first name, e.g. Simon then the folder created
will be `\\server\share\simon` . To keep things neat, the path will be
converted to lower case.

**profile_version:** Windows has several profiles version for roaming profiles. These are denoted
by append the version number to the filename, for example.

`\\server1\share\simon` 

Would become.

`\\server1\share\simon.V5` 

Full details of these versions can be found [here](https://support.microsoft.com/en-gb/help/3056198/roaming-user-profiles-versioning-in-windows-10-and-windows-server).

